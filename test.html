<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Cognigy Plugin Test</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script>
        // Mock Cognigy Webchat Environment
        window.__COGNIGY_WEBCHAT = {
            React: window.React,
            ReactDOM: window.ReactDOM
        };

        // Mock sendMessage (should NOT be called now)
        window.cognigyWebchat = {
            sendMessage: (text, data) => {
                console.error('Mock sendMessage called UNEXPECTEDLY:', text, data);
                const statusDiv = document.getElementById('command-status');
                if (statusDiv) {
                    statusDiv.textContent = `Error: sendMessage was called!`;
                    statusDiv.style.color = 'red';
                }
            }
        };

        window.cognigyWebchatMessagePlugins = [];
    </script>
</head>

<body>
    <h1>Cognigy Plugin Verification</h1>

    <h2>Counter Plugin</h2>
    <div id="counter-status">Waiting...</div>
    <div id="counter-container"></div>

    <h2>Table Plugin (Array Data)</h2>
    <div id="table-status">Waiting...</div>
    <div id="table-container"></div>

    <h2>Table Plugin (String Data)</h2>
    <div id="table-string-status">Waiting...</div>
    <div id="table-string-container"></div>

    <h2>Headless Command Plugin</h2>
    <div id="command-status">Waiting (Should remain empty)...</div>
    <div id="command-container"></div>

    <script src="./dist/plugin.js"></script>

    <script>
        const renderPlugin = (match, containerId, statusId, mockMessage) => {
            const statusDiv = document.getElementById(statusId);
            const container = document.getElementById(containerId);

            const plugin = window.cognigyWebchatMessagePlugins.find(p => p.match === match);

            if (plugin) {
                statusDiv.textContent = `Plugin registered: ${plugin.match}`;
                statusDiv.style.color = 'green';

                try {
                    const root = ReactDOM.createRoot(container);
                    // Pass the mock message as props
                    root.render(React.createElement(plugin.component, { message: mockMessage }));
                } catch (e) {
                    console.error(e);
                    statusDiv.textContent += ' (Render failed, check console)';
                    statusDiv.style.color = 'orange';
                }
            } else {
                statusDiv.textContent = `Plugin '${match}' not found.`;
                statusDiv.style.color = 'red';
            }
        };

        // Test Counter
        renderPlugin('counter', 'counter-container', 'counter-status', {});

        // Test Table (Array)
        const mockTableMessage = {
            data: {
                _plugin: {
                    data: [
                        { id: 1, name: 'Alice', role: 'Admin' },
                        { id: 2, name: 'Bob', role: 'User' }
                    ]
                }
            }
        };
        renderPlugin('table', 'table-container', 'table-status', mockTableMessage);

        // Test Table (String)
        const mockTableStringMessage = {
            data: {
                _plugin: {
                    data: JSON.stringify([
                        { id: 3, name: 'Charlie', role: 'Guest' },
                        { id: 4, name: 'Dave', role: 'Support' }
                    ])
                }
            }
        };
        renderPlugin('table', 'table-string-container', 'table-string-status', mockTableStringMessage);

        // Test Headless Command
        const mockCommandMessage = {
            data: {
                _plugin: {
                    type: 'command',
                    payload: {
                        action: 'update-profile',
                        user: 'Petr'
                    }
                }
            }
        };
        // Note: We render it. We expect NO visual output and NO side effects (sendMessage not called).
        renderPlugin('command', 'command-container', 'command-status', mockCommandMessage);

        // Update status to confirm it rendered without error
        setTimeout(() => {
            const statusDiv = document.getElementById('command-status');
            if (statusDiv.textContent === 'Plugin registered: command') {
                statusDiv.textContent += ' (Passive Mode Verified)';
            }
        }, 500);

    </script>
</body>

</html>